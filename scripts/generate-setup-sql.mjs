import { readdir, readFile, writeFile } from "node:fs/promises";
import path from "node:path";
import process from "node:process";

const projectRoot = process.cwd();
const migrationsDir = path.join(projectRoot, "supabase", "migrations");
const outputFile = path.join(projectRoot, "SETUP_DB.sql");

function migrationSort(left, right) {
  const leftMatch = left.match(/^(\d+)_/);
  const rightMatch = right.match(/^(\d+)_/);
  const leftNum = leftMatch ? Number(leftMatch[1]) : Number.MAX_SAFE_INTEGER;
  const rightNum = rightMatch ? Number(rightMatch[1]) : Number.MAX_SAFE_INTEGER;
  if (leftNum !== rightNum) return leftNum - rightNum;
  return left.localeCompare(right);
}

const files = (await readdir(migrationsDir))
  .filter((file) => file.endsWith(".sql"))
  .sort(migrationSort);

const sections = await Promise.all(
  files.map(async (file) => {
    const fullPath = path.join(migrationsDir, file);
    const content = await readFile(fullPath, "utf8");
    return `-- ============================================================\n-- MIGRATION: ${file}\n-- ============================================================\n\n${content.trim()}\n`;
  })
);

const output = `-- ============================================================================\n-- SETUP_DB.sql (CANONICAL)\n-- AUTO-GENERATED FROM supabase/migrations/*.sql\n--\n-- HOW TO USE:\n-- 1) For a NEW database, run this file once in Supabase SQL Editor.\n-- 2) For an EXISTING database, prefer incremental migrations.\n--\n-- DO NOT EDIT THIS FILE MANUALLY.\n-- Source of truth: supabase/migrations/*.sql\n-- Regenerate with: npm run db:bundle\n-- ============================================================================\n\n${sections.join("\n")}`;

await writeFile(outputFile, output, "utf8");
console.log(`Generated ${path.relative(projectRoot, outputFile)} from ${files.length} migrations.`);
